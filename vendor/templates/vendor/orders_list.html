{% extends "vendor/base_vendor.html" %}
{% load static %}
{% load price_tags %} {# IMPORTANT: Added price_tags load for the 'money' filter #}

{% block vendor_content %}
<div class="container mt-4" dir="rtl">
  <h3>سفارش‌ها</h3>

  <div class="d-flex justify-content-between align-items-center mb-3">
    
    {# 1. Status Filter (Filtering by Delivery Condition) #}
    <div class="btn-group" role="group">
      <a href="{% url 'vendor:orders' %}?status=all&sort={{ request.GET.sort|default:'-created_at' }}" 
         class="btn btn-sm {% if not request.GET.status or request.GET.status == 'all' %}btn-info{% else %}btn-outline-info{% endif %}">همه</a>
      <a href="{% url 'vendor:orders' %}?status=new&sort={{ request.GET.sort|default:'-created_at' }}" 
         class="btn btn-sm {% if request.GET.status == 'new' %}btn-warning{% else %}btn-outline-warning{% endif %}">جدید</a>
      <a href="{% url 'vendor:orders' %}?status=delivered&sort={{ request.GET.sort|default:'-created_at' }}" 
         class="btn btn-sm {% if request.GET.status == 'delivered' %}btn-success{% else %}btn-outline-success{% endif %}">تحویل شده</a>
      {# You can add more status filters here if applicable (e.g., preparing, ready) #}
    </div>

    {# 2. Date Sort (Sorting by Time) #}
    <div class="btn-group" role="group">
      <span class="mr-2 pt-1 text-secondary">مرتب‌سازی زمان:</span>
      <a href="{% url 'vendor:orders' %}?status={{ request.GET.status|default:'all' }}&sort=-created_at" 
         class="btn btn-sm {% if not request.GET.sort or request.GET.sort == '-created_at' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">جدیدترین</a>
      <a href="{% url 'vendor:orders' %}?status={{ request.GET.status|default:'all' }}&sort=created_at" 
         class="btn btn-sm {% if request.GET.sort == 'created_at' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">قدیمی‌ترین</a>
    </div>
  </div>
  <div class="table-responsive"> <table class="table table-bordered mt-3">
      <thead>
        <tr>
          <th>#</th>
          <th>میز</th>
          <th>وضعیت</th>
          <th>مبلغ کل</th> 
          <th>زمان</th>
          <th>عملیات</th>
        </tr>
      </thead>
      <tbody id="orders-tbody">
        {% for order in orders %}
        <tr id="order-row-{{ order.id }}" class="{% if order.status == 'new' %}table-warning{% endif %}">
          <td>{{ order.id }}</td>
          <td>{{ order.table }}</td>
          <td id="order-status-{{ order.id }}">{{ order.get_status_display }}</td>
          <td>{{ order.total_cents|money }}</td> 
          <td>{{ order.created_at|date:"Y-m-d H:i" }}</td>
          <td>
            <a class="btn btn-sm btn-info" href="{% url 'vendor:order_detail' order.id %}">نمایش</a>
            {% if order.status != "delivered" %}
            <button class="btn btn-sm btn-success" onclick="completeOrder({{ order.id }})">تکمیل شد</button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
</div>

<script>
function getCookie(name){
  let v = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}

function completeOrder(id){
  if (!confirm('آیا سفارش به عنوان تکمیل شده علامت زده شود؟')) return;
  fetch("{% url 'vendor:order_complete' 0 %}".replace('/0/','/'+id+'/'), {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({})
  }).then(r=>r.json()).then(data=>{
    if (data.ok){
      // Update UI on success
      let statusCell = document.getElementById('order-status-'+id);
      if (statusCell) {
        statusCell.innerText = 'تحویل شده';
        document.getElementById('order-row-'+id).classList.remove('table-warning');
        // Disable the button after completion
        const button = statusCell.nextElementSibling.nextElementSibling.querySelector('button');
        if (button) button.remove();
      }
    } else {
      alert(data.error || 'خطا');
    }
  }).catch(e=>{ alert('خطا: '+e); });
}
</script>

{% endblock %}